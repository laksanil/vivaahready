generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ApprovalStatus: "pending" | "approved" | "rejected"

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String
  phone         String?
  emailVerified DateTime?
  phoneVerified DateTime?
  lastLogin     DateTime?
  lastNewMatchNotificationAt DateTime? // Track when user was last notified of new matches
  mustChangePassword Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile      Profile?
  subscription Subscription?
  sentMatches     Match[] @relation("SentMatches")
  receivedMatches Match[] @relation("ReceivedMatches")
  sentMessages    Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  reportsFiled    Report[] @relation("ReportsFiled")
  reportsReceived Report[] @relation("ReportsReceived")
  deletionRequest DeletionRequest?
}

model Profile {
  id        String   @id @default(cuid())
  odNumber  String?  @unique // Unique reference number
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Name fields (stored separately from user.name which is auto-formatted as "Firstname L.")
  firstName         String?  // Full first name as entered by user
  lastName          String?  // Full last name as entered by user

  // Basic Info (from Google Form)
  gender            String?  // male, female - optional until basics step completed
  dateOfBirth       String?  // MM/DD/YYYY format
  age               String?  // Age in years (alternative to DOB)
  placeOfBirth      String?
  height            String?
  weight            String?  // Weight in kg or lbs
  dietaryPreference String?  // Vegetarian, Non Vegetarian, Eggetarian, Vegan
  motherTongue      String?  // Primary language
  healthInfo        String?  // Health conditions
  anyDisability     String?  // none, physical
  disabilityDetails String?  // Details if physical disability
  bloodGroup        String?  // A+, A-, B+, B-, AB+, AB-, O+, O-
  languagesKnown    String?
  maritalStatus     String?  // Single, Never Married, Divorced
  hasChildren       String?  // no, yes_living_together, yes_not_living_together

  // Contact & Social
  linkedinProfile   String?
  facebookInstagram String?  // Legacy field - kept for backwards compatibility
  facebook          String?
  instagram         String?
  photoUrls         String?  // Comma-separated URLs from Google Drive
  profileImageUrl   String?  // Primary display photo (extracted from photoUrls or uploaded)
  drivePhotosLink   String?  // Link to Google Drive folder for additional photos
  photoVisibility   String?  @default("verified_only") // verified_only, matching_preferences, mutual_interest

  // Family Details
  fatherName        String?
  motherName        String?
  fatherOccupation  String?
  motherOccupation  String?
  numberOfBrothers  String?
  numberOfSisters   String?
  siblingDetails    String?
  familyDetails     String?  // Additional family details text box
  familyType        String?  // nuclear, joint
  familyValues      String?  // traditional, moderate, liberal
  familyLocation    String?

  // Education & Career
  qualification     String?  // Bachelors, Masters, Doctor, Ph.D
  university        String?
  occupation        String?
  annualIncome      String?  // Range like "100-150K", ">100k"
  currentLocation   String?  // City, State
  zipCode           String?  // US zip code for distance calculations

  // Background
  religion          String?  // Hindu, Muslim, Christian, etc.
  community         String?  // Community based on religion (e.g., Brahmin, Reddy for Hindu)
  subCommunity      String?  // Sub-community (e.g., Madhwa, Smartha for Brahmin)
  caste             String?  // Legacy field - kept for backwards compatibility
  gotra             String?

  // Additional Career Details
  employerName      String?  // Company name
  workingAs         String?  // Job title/role
  educationCareerDetails String?  // Additional education/career info

  // Living Situation
  livesWithFamily   String?  // yes, no
  createdBy         String?  // self, parent, sibling, relative, friend

  // Birth Details (shown for all religions)
  placeOfBirthCountry String?
  placeOfBirthState   String?
  placeOfBirthCity    String?

  // Hindu-specific Astro Details
  timeOfBirth         String?
  manglik             String?  // yes, no, dont_know
  raasi               String?  // Moon sign
  nakshatra           String?  // Birth star
  doshas              String?  // Doshas if any

  // Muslim-specific fields
  maslak              String?  // School of thought: hanafi, shafi, maliki, hanbali, etc.
  namazPractice       String?  // Prayer practice: five_times, sometimes, friday_only, etc.

  // Sikh-specific fields
  amritdhari          String?  // Baptized: yes, no, keshdhari
  turban              String?  // yes, no

  // Christian-specific fields
  churchAttendance    String?  // weekly, occasionally, special_occasions, rarely
  baptized            String?  // yes, no

  // Lifestyle
  smoking           String?  // no, occasionally, yes
  drinking          String?  // no, social, yes
  hobbies           String?  // Comma-separated hobbies
  fitness           String?  // Comma-separated fitness activities
  interests         String?  // Comma-separated interests
  pets              String?  // have_love, no_but_love, no_but_open, prefer_not, allergic
  allergiesOrMedical String? // Allergies or medical conditions

  // About
  aboutMe           String?

  // Partner Preferences
  prefHeight        String?  // Legacy - kept for backwards compatibility
  prefHeightMin     String?  // Minimum preferred height
  prefHeightMax     String?  // Maximum preferred height
  prefAgeDiff       String?  // Legacy - "< 3 years", "between 3 to 5 years", etc.
  prefAgeMin        String?  // Minimum preferred age
  prefAgeMax        String?  // Maximum preferred age
  prefLocation      String?
  prefLocationList  String?  // Comma-separated list of preferred US states
  prefDiet          String?
  prefSmoking       String?  // doesnt_matter, no, occasionally_ok
  prefDrinking      String?  // doesnt_matter, no, social_ok
  prefCommunity     String?  // JSON array of preferred communities or "same_as_mine" or "doesnt_matter"
  prefSubCommunity  String?  // JSON array of preferred sub-communities or "same_as_mine" or "doesnt_matter"
  prefCaste         String?  // Legacy field - kept for backwards compatibility
  prefGotra         String?  // "Different Gothra", "Doesn't Matter"
  prefQualification String?
  prefWorkArea      String?  // Preferred work area/industry
  prefOccupation    String?  // Preferred occupation/job title
  prefIncome        String?
  prefLanguage      String?
  prefCountry       String?  // Legacy - kept for backwards compatibility
  prefCitizenship   String?  // Preferred citizenship/nationality
  prefHobbies       String?  // doesnt_matter, same_as_mine, specific
  prefSpecificHobbies String? // Comma-separated specific hobbies if prefHobbies = specific
  prefFitness       String?  // doesnt_matter, same_as_mine, specific
  prefSpecificFitness String? // Comma-separated specific fitness if prefFitness = specific
  prefInterests     String?  // doesnt_matter, same_as_mine, specific
  prefSpecificInterests String? // Comma-separated specific interests if prefInterests = specific
  prefGrewUpIn      String?  // doesnt_matter, same_as_mine, specific country
  prefMaritalStatus String?  // never_married, doesnt_matter, divorced_ok, widowed_ok
  prefHasChildren   String?  // doesnt_matter, no_children, ok_with_children, must_have_children
  prefRelocation    String?  // doesnt_matter, willing, not_required
  prefMotherTongue  String?  // doesnt_matter, same_as_mine, specific language
  prefPets          String?  // doesnt_matter, must_love, no_pets, open_to_pets
  prefReligion      String?  // LEGACY: Single religion preference (kept for backwards compatibility)
  prefReligions     String[] @default([])  // NEW: Multi-select religion preferences (empty = doesn't matter)
  prefFamilyValues  String?  // doesnt_matter, traditional, moderate, liberal
  prefFamilyLocation String?  // doesnt_matter, same_country, specific_country
  prefFamilyLocationCountry String?  // Specific country name if prefFamilyLocation is specific
  idealPartnerDesc  String?  // Free text description

  // Deal-breaker flags for partner preferences
  // If true, the preference is a deal-breaker (hard filter)
  // If false/null, the preference is optional (soft preference)
  prefAgeIsDealbreaker          Boolean @default(true)
  prefHeightIsDealbreaker       Boolean @default(true)
  prefMaritalStatusIsDealbreaker Boolean @default(true)
  prefHasChildrenIsDealbreaker  Boolean @default(false)
  prefCommunityIsDealbreaker    Boolean @default(false)
  prefGotraIsDealbreaker        Boolean @default(false)
  prefDietIsDealbreaker         Boolean @default(false)
  prefSmokingIsDealbreaker      Boolean @default(false)
  prefDrinkingIsDealbreaker     Boolean @default(false)
  prefLocationIsDealbreaker     Boolean @default(false)
  prefCitizenshipIsDealbreaker  Boolean @default(false)
  prefGrewUpInIsDealbreaker     Boolean @default(false)
  prefRelocationIsDealbreaker   Boolean @default(false)
  prefEducationIsDealbreaker    Boolean @default(false)
  prefWorkAreaIsDealbreaker     Boolean @default(false)
  prefIncomeIsDealbreaker       Boolean @default(false)
  prefOccupationIsDealbreaker   Boolean @default(false)
  prefFamilyValuesIsDealbreaker Boolean @default(false)
  prefFamilyLocationIsDealbreaker Boolean @default(false)
  prefMotherTongueIsDealbreaker Boolean @default(false)
  prefSubCommunityIsDealbreaker Boolean @default(false)
  prefPetsIsDealbreaker         Boolean @default(false)
  prefReligionIsDealbreaker     Boolean @default(true)

  // Metadata
  citizenship       String?
  residencyStatus   String?
  grewUpIn          String?
  country           String?
  openToRelocation  String?  // yes, no, depends - User's willingness to relocate
  promoCode         String?
  referralSource    String?
  referralCode      String?  @unique // Auto-generated code for sharing referral links
  referredBy        String?  // Referral code of the user who referred this profile
  referralBoostStart DateTime? // When the referral boost (3+ referrals) was activated

  // Campaign/Acquisition Tracking
  utm_source        String?  // e.g., "google", "facebook", "instagram"
  utm_medium        String?  // e.g., "cpc", "organic", "social"
  utm_campaign      String?  // e.g., "spring-promo", "summer-launch"
  utm_content       String?  // e.g., "ad-variant-a", "email-banner"
  utm_term          String?  // e.g., "indian matrimony"
  acquisitionChannel String? // High-level channel: "organic", "paid_search", "social", "referral"

  isImported        Boolean  @default(false)

  // Lifetime Stats (never decrease, used to showcase platform value)
  lifetimeInterestsReceived  Int  @default(0)  // Total interests ever received
  lifetimeInterestsSent      Int  @default(0)  // Total interests ever sent
  lifetimeProfileViews       Int  @default(0)  // Total profile views ever received
  lifetimeMatches            Int  @default(0)  // Total potential matches ever shown (high-water mark)
  lifetimeMutualMatches      Int  @default(0)  // Total mutual matches/connections ever made

  // Signup Progress (tracks which step user completed during multi-step signup)
  // Steps: 1=basics, 2=location_education, 3=account, 4=religion, 5=family, 6=lifestyle, 7=aboutme, 8=preferences_1, 9=preferences_2, 10=photos
  signupStep        Int    @default(3)  // Defaults to 3 (account) since profile is created at step 3

  // Status
  approvalStatus    String @default("pending")
  approvalDate      DateTime?
  rejectionReason   String?
  isVerified        Boolean  @default(false)
  isActive          Boolean  @default(true)
  isSuspended       Boolean  @default(false)
  suspendedAt       DateTime?
  suspendedReason   String?
  profileScore      Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Match {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  sender      User     @relation("SentMatches", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("ReceivedMatches", fields: [receiverId], references: [id], onDelete: Cascade)

  status      String   @default("pending") // pending, accepted, rejected
  message     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([senderId, receiverId])
}

model Subscription {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan            String   @default("free") // free, premium
  status          String   @default("active")

  // Profile payment tracking ($10 one-time fee)
  profilePaid     Boolean  @default(false)
  profilePaymentId String?  // Stripe payment intent ID

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  content     String
  read        Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([senderId, receiverId])
  @@index([receiverId, read, createdAt])  // Optimizes unread message queries
  @@index([createdAt])                     // Optimizes sorting by time
}

model Report {
  id              String   @id @default(cuid())
  reporterId      String   // User who filed the report
  reportedUserId  String   // User being reported
  reporter        User     @relation("ReportsFiled", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser    User     @relation("ReportsReceived", fields: [reportedUserId], references: [id], onDelete: Cascade)

  reason          String   // Text description of the problem
  status          String   @default("pending") // pending, reviewed, resolved, dismissed
  adminNotes      String?  // Notes from admin after review
  actionTaken     String?  // What action was taken (e.g., "suspended", "warned", "dismissed")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reviewedAt      DateTime?

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
}

// Tracks profiles that a user has declined (not interested in)
// These profiles won't show in matching results but can be reconsidered
model DeclinedProfile {
  id              String   @id @default(cuid())
  userId          String   // User who declined
  declinedUserId  String   // User whose profile was declined

  createdAt       DateTime @default(now())

  @@unique([userId, declinedUserId])
  @@index([userId])
  @@index([declinedUserId])
}

// Tracks profile deletion requests from users
// Admin must approve and process these requests
model DeletionRequest {
  id              String   @id @default(cuid())
  userId          String   @unique // User requesting deletion
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  reason          String   // Predefined reason code
  otherReason     String?  // Custom reason if "other" selected

  status          String   @default("pending") // pending, approved, rejected, completed
  adminNotes      String?  // Notes from admin
  processedAt     DateTime?
  processedBy     String?  // Admin who processed the request

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Tracks PayPal orders for payment recovery
// If client-side capture fails, we can retry or match via webhook
model PendingPayment {
  id              String   @id @default(cuid())
  userId          String   // User who initiated payment
  paypalOrderId   String   @unique // PayPal order ID
  amount          String   // Payment amount

  status          String   @default("pending") // pending, captured, failed, expired
  captureAttempts Int      @default(0) // Number of capture attempts
  lastError       String?  // Last error message

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  capturedAt      DateTime?

  @@index([userId])
  @@index([status])
  @@index([paypalOrderId])
}

// Site settings (singleton - only one row)
model Settings {
  id                  String   @id @default("default")
  verificationPrice   Int      @default(50)  // Price in dollars
  promoPrice          Int?     // Optional promo price
  promoEndDate        DateTime? // When promo expires
  updatedAt           DateTime @updatedAt
}

// Events (Singles Meetups, etc.)
model Event {
  id              String   @id @default(cuid())
  slug            String   @unique // URL-friendly identifier (e.g., "march-2025-vegetarian")
  title           String   // "Singles Zoom Meetup - March 2025"
  description     String?  // Rich description
  eventDate       DateTime // Event date and time
  timezone        String   @default("America/Los_Angeles") // PST
  duration        Int      @default(60) // Duration in minutes

  // Capacity
  maxMaleSpots    Int      @default(10)
  maxFemaleSpots  Int      @default(10)

  // Eligibility
  minAge          Int      @default(24)
  maxAge          Int      @default(35)
  dietaryReq      String?  // "vegetarian" or null for all
  locationReq     String?  // "California" or null for all

  // Pricing
  price           Int      @default(25) // Price in dollars

  // Event details
  zoomLink        String?  // Zoom meeting link (hidden until event day)
  zoomPassword    String?  // Zoom password if needed

  // Status
  status          String   @default("upcoming") // upcoming, live, completed, cancelled
  isPublished     Boolean  @default(true)

  // Minimum to run (secret - not shown to users)
  minAttendeesToRun Int    @default(10)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  registrations   EventRegistration[]

  @@index([status])
  @@index([eventDate])
  @@index([slug])
}

// Event Registrations
model EventRegistration {
  id              String   @id @default(cuid())
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  profileId       String   // Links to Profile (has VR ID / odNumber)

  // Registration status
  status          String   @default("registered") // registered, waitlisted, cancelled, attended, no_show

  // Payment
  paymentStatus   String   @default("pending") // pending, paid, refunded
  paymentId       String?  // Square transaction ID
  amountPaid      Int?     // Amount in cents

  // Communication preferences
  whatsappOptIn   Boolean  @default(false)
  smsOptIn        Boolean  @default(false)

  // Tracking
  registeredAt    DateTime @default(now())
  cancelledAt     DateTime?
  cancellationReason String? // Why they cancelled
  refundedAt      DateTime?
  refundId        String?  // Square refund ID
  attendedAt      DateTime? // Marked when they join the Zoom

  // Waitlist position (null if not on waitlist)
  waitlistPosition Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([eventId, profileId]) // One registration per profile per event
  @@index([eventId])
  @@index([profileId])
  @@index([status])
  @@index([paymentStatus])
}

// Support Messages (from chatbot escalation or contact form)
model SupportMessage {
  id              String   @id @default(cuid())

  // Sender info (can be anonymous or logged in user)
  userId          String?  // If logged in
  name            String?  // Name if provided
  email           String?  // Email if provided
  phone           String?  // Phone if provided

  // Message content
  subject         String?  // Optional subject
  message         String   // The actual message
  context         String?  // Where the message came from (e.g., "marchevent", "chatbot")

  // Admin response
  status          String   @default("new") // new, read, replied, resolved
  adminResponse   String?  // Admin's response
  respondedAt     DateTime?
  respondedVia    String?  // email, sms, whatsapp

  // Chat history (JSON array of chat messages if from chatbot)
  chatHistory     String?  // JSON string of chat messages

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([userId])
  @@index([createdAt])
}
